import { DynamoDBClient } from '@aws-sdk/client-dynamodb';
import { DynamoDBDocumentClient, QueryCommand } from '@aws-sdk/lib-dynamodb';

const client = new DynamoDBClient({ region: 'ap-south-1' });
const dynamodb = DynamoDBDocumentClient.from(client);

export const handler = async (event) => {
    console.log('Event:', JSON.stringify(event, null, 2));
    
    try {
        const params = event.queryStringParameters || {};
        const { user_id, product_id, type = 'general' } = params;
        
        console.log('Getting recommendations for:', { user_id, product_id, type });
        
        // Get user's viewing history
        let recommendations = [];
        
        if (user_id) {
            recommendations = await getUserBasedRecommendations(user_id);
        } else if (product_id) {
            recommendations = await getProductBasedRecommendations(product_id);
        } else {
            recommendations = await getPopularProducts();
        }
        
        return {
            statusCode: 200,
            headers: {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Headers': 'Content-Type,Authorization',
                'Access-Control-Allow-Methods': 'GET,OPTIONS',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                recommendations: recommendations.slice(0, 8),
                type: type,
                count: recommendations.length
            })
        };
        
    } catch (error) {
        console.error('Error:', error);
        return {
            statusCode: 500,
            headers: { 'Access-Control-Allow-Origin': '*' },
            body: JSON.stringify({ error: error.message })
        };
    }
};

async function getUserBasedRecommendations(userId) {
    // Get user's activity
    const activityParams = {
        TableName: 'UserActivity',
        KeyConditionExpression: 'user_id = :userId',
        ExpressionAttributeValues: {
            ':userId': userId
        },
        Limit: 50,
        ScanIndexForward: false
    };
    
    const activity = await dynamodb.send(new QueryCommand(activityParams));
    const viewedProducts = activity.Items || [];
    
    if (viewedProducts.length === 0) {
        return getPopularProducts();
    }
    
    // Get categories user is interested in
    const categories = [...new Set(viewedProducts.map(v => v.category).filter(Boolean))];
    
    // Get popular products from those categories
    return getProductsByCategories(categories);
}

async function getProductBasedRecommendations(productId) {
    // Get the product details
    const productParams = {
        TableName: 'Products',
        Key: { product_id: productId }
    };
    
    try {
        const result = await dynamodb.send(new QueryCommand(productParams));
        const product = result.Item;
        
        if (product && product.category) {
            return getCategoryRecommendations(product.category, productId);
        }
    } catch (error) {
        console.log('Product not found, returning popular');
    }
    
    return getPopularProducts();
}

async function getCategoryRecommendations(category, excludeProductId) {
    const params = {
        TableName: 'Products',
        IndexName: 'CategoryIndex',
        KeyConditionExpression: 'category = :category',
        ExpressionAttributeValues: {
            ':category': category
        },
        Limit: 20
    };
    
    const result = await dynamodb.send(new QueryCommand(params));
    let products = result.Items || [];
    
    // Exclude current product
    products = products.filter(p => p.product_id !== excludeProductId);
    
    // Sort by popularity
    products.sort((a, b) => (b.popularity_score || 0) - (a.popularity_score || 0));
    
    return products;
}

async function getProductsByCategories(categories) {
    let allProducts = [];
    
    for (const category of categories.slice(0, 3)) {
        const products = await getCategoryRecommendations(category);
        allProducts = allProducts.concat(products);
    }
    
    // Remove duplicates and sort by popularity
    const unique = [...new Map(allProducts.map(p => [p.product_id, p])).values()];
    unique.sort((a, b) => (b.popularity_score || 0) - (a.popularity_score || 0));
    
    return unique;
}

async function getPopularProducts() {
    const params = {
        TableName: 'Products',
        FilterExpression: 'is_featured = :featured OR popularity_score > :score',
        ExpressionAttributeValues: {
            ':featured': true,
            ':score': 70
        },
        Limit: 20
    };
    
    const result = await dynamodb.send(new QueryCommand(params));
    const products = result.Items || [];
    
    products.sort((a, b) => (b.popularity_score || 0) - (a.popularity_score || 0));
    
    return products;
}
